from telegram import (
    Update,
    ReplyKeyboardMarkup,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)
import sqlite3

# ================= CONFIG =================
BOT_TOKEN = "8522151722:AAGUK-MbECrSR_NcSUZDzxHKqiFtt3Q6gIc"
ADMIN_ID = 7585418090  # ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ Telegram ID

# ================= DATABASE =================
db = sqlite3.connect("bot.db", check_same_thread=False)
sql = db.cursor()

sql.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    balance INTEGER DEFAULT 0,
    ref_by INTEGER DEFAULT 0,
    banned INTEGER DEFAULT 0
)
""")

sql.execute("""
CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT
)
""")

sql.execute("INSERT OR IGNORE INTO settings VALUES ('work_point','5')")
sql.execute("INSERT OR IGNORE INTO settings VALUES ('min_withdraw','100')")
sql.execute("INSERT OR IGNORE INTO settings VALUES ('force_channels','')")
db.commit()

# ================= HELPERS =================
def get_setting(key):
    sql.execute("SELECT value FROM settings WHERE key=?", (key,))
    return sql.fetchone()[0]

def set_setting(key, value):
    sql.execute("UPDATE settings SET value=? WHERE key=?", (value, key))
    db.commit()

def is_admin(user_id):
    return user_id == ADMIN_ID

def get_force_channels():
    ch = get_setting("force_channels")
    return ch.split(",") if ch else []

async def check_join(user_id, bot):
    for ch in get_force_channels():
        try:
            m = await bot.get_chat_member(ch, user_id)
            if m.status in ["left", "kicked"]:
                return False
        except:
            return False
    return True

# ================= MENUS =================
def user_menu():
    return ReplyKeyboardMarkup(
        [
            ["‚úÖ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®", "üí∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏"],
            ["üë• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞", "üí∏ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞"],
            ["‚ÑπÔ∏è ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ"]
        ],
        resize_keyboard=True
    )

def admin_menu():
    return ReplyKeyboardMarkup(
        [
            ["üëë ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤"],
            ["üìä ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏", "‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏"],
            ["‚¨ÖÔ∏è ‡¶Æ‡ßá‡¶®‡ßÅ"]
        ],
        resize_keyboard=True
    )

# ================= START =================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    sql.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user.id,))
    db.commit()

    if not await check_join(user.id, context.bot):
        buttons = []
        for ch in get_force_channels():
            buttons.append(
                [InlineKeyboardButton(f"üì¢ Join {ch}", url=f"https://t.me/{ch.replace('@','')}")]
            )
        buttons.append([InlineKeyboardButton("‚úÖ ‡¶ö‡ßá‡¶ï", callback_data="check")])
        await update.message.reply_text(
            "üö´ ‡¶¨‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® üëá",
            reply_markup=InlineKeyboardMarkup(buttons)
        )
        return

    await update.message.reply_text(
        "üéâ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!\n‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶® üí∏",
        reply_markup=user_menu()
    )

# ================= CALLBACK =================
async def callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()

    if q.data == "check":
        if await check_join(q.from_user.id, context.bot):
            await q.message.edit_text("‚úÖ ‡¶∏‡¶´‡¶≤! ‡¶è‡¶ñ‡¶® /start ‡¶¶‡¶ø‡¶®")
        else:
            await q.answer("‚ùå ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø", show_alert=True)

# ================= USER ACTIONS =================
async def user_actions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user_id = update.effective_user.id

    if text == "‚úÖ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®":
        point = int(get_setting("work_point"))
        sql.execute("UPDATE users SET balance = balance + ? WHERE user_id=?", (point, user_id))
        db.commit()
        await update.message.reply_text(f"‚úÖ ‡¶ï‡¶æ‡¶ú ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!\n‚ûï {point} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá")

    elif text == "üí∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏":
        sql.execute("SELECT balance FROM users WHERE user_id=?", (user_id,))
        bal = sql.fetchone()[0]
        await update.message.reply_text(f"üí∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {bal} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü")

    elif text == "üë• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞":
        link = f"https://t.me/{context.bot.username}?start={user_id}"
        await update.message.reply_text(f"üë• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n{link}")

    elif text == "‚ÑπÔ∏è ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ":
        await update.message.reply_text(
            "üìú ‡¶®‡¶ø‡ßü‡¶Æ‡¶æ‡¶¨‡¶≤‡¶ø:\n"
            "1Ô∏è‚É£ ‡¶¶‡¶ø‡¶®‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú\n"
            "2Ô∏è‚É£ ‡¶´‡ßá‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®\n"
            "3Ô∏è‚É£ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø"
        )

    elif text == "üëë ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤" and is_admin(user_id):
        await update.message.reply_text("üëë Admin Panel", reply_markup=admin_menu())

    elif text == "üìä ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏" and is_admin(user_id):
        sql.execute("SELECT COUNT(*) FROM users")
        total = sql.fetchone()[0]
        await update.message.reply_text(f"üìä ‡¶Æ‡ßã‡¶ü ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: {total}")

    elif text == "‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏" and is_admin(user_id):
        wp = get_setting("work_point")
        mw = get_setting("min_withdraw")
        await update.message.reply_text(
            f"‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏:\n"
            f"üîπ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü: {wp}\n"
            f"üîπ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: {mw}\n\n"
            "‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°:\n"
            "/set_work 10\n"
            "/set_withdraw 200\n"
            "/add_channel @channel\n"
            "/remove_channel @channel"
        )

    elif text == "‚¨ÖÔ∏è ‡¶Æ‡ßá‡¶®‡ßÅ":
        await update.message.reply_text("‡¶Æ‡ßá‡¶®‡ßÅ", reply_markup=user_menu())

# ================= ADMIN COMMANDS =================
async def set_work(update, context):
    if is_admin(update.effective_user.id):
        set_setting("work_point", context.args[0])
        await update.message.reply_text("‚úÖ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü")

async def set_withdraw(update, context):
    if is_admin(update.effective_user.id):
        set_setting("min_withdraw", context.args[0])
        await update.message.reply_text("‚úÖ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü")

async def add_channel(update, context):
    if is_admin(update.effective_user.id):
        ch = context.args[0]
        channels = get_force_channels()
        if ch not in channels:
            channels.append(ch)
            set_setting("force_channels", ",".join(channels))
        await update.message.reply_text("‚úÖ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá")

async def remove_channel(update, context):
    if is_admin(update.effective_user.id):
        ch = context.args[0]
        channels = get_force_channels()
        if ch in channels:
            channels.remove(ch)
            set_setting("force_channels", ",".join(channels))
        await update.message.reply_text("‚ùå ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠")

# ================= RUN =================
app = ApplicationBuilder().token(BOT_TOKEN).build()

app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(callback))
app.add_handler(CommandHandler("set_work", set_work))
app.add_handler(CommandHandler("set_withdraw", set_withdraw))
app.add_handler(CommandHandler("add_channel", add_channel))
app.add_handler(CommandHandler("remove_channel", remove_channel))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, user_actions))

print("üî• Professional Bot Running...")
app.run_polling()
